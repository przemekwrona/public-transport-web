<!-- Container -->
<div class="container-fixed">
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-gray-900">
                Linia {{ state?.line }} {{ state?.name }}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-gray-700">
                Konfiguracja lini autobusowej
            </div>
        </div>
        <div class="flex items-center gap-2.5">
            <a [routerLink]="['/agency/trips']" [queryParams]="{line: state.line, name: state.name}"
               class="btn btn-sm btn-secondary">Wróć do lini</a>
        </div>
    </div>
</div>
<!-- End of Container -->

<!-- Container -->
<div class="container-fixed">
    <!-- begin: grid -->
    <form [formGroup]="modelForm" (ngSubmit)="clickCreateOrEdit(modelForm)">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 lg:gap-7.5">
            <div class="col-span-1">
                <div class="grid gap-5 lg:gap-7.5">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Informacje Podstawowe</h3></div>
                        <div class="card-body grid gap-5">
                            <div class="flex items-center justify-between border border-gray-200 rounded-xl gap-2 px-3.5 py-2.5">
                                <div class="flex items-center flex-wrap gap-3.5">
                                    <!--                                <img src="/assets/media/brand-logos/google.svg" class="size-6 shrink-0" alt="">-->
                                    <div class="flex flex-col gap-0.5">
                                    <span class="text-sm font-medium text-gray-900">Wariant
                                        Podstawowy</span>
                                        <span class="text-2sm text-gray-700">
                                        <strong>Wariant podstawowy trasy autobusowej</strong> to główny, standardowy
                                        przebieg trasy, którą dany autobus pokonuje zgodnie z rozkładem jazdy. Jest to
                                        najbardziej typowa i regularna wersja trasy, która obowiązuje przez większość
                                        kursów danej linii.
                                    </span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-5">
                                    <label class="switch switch-sm">
                                        <input type="checkbox" formControlName="isMainVariant"/>
                                    </label>
                                </div>
                            </div>

                            @if (modelForm?.errors?.["variantExists"]) {
                                <span class="badge badge-sm badge-outline badge-danger block"
                                      style="line-height: inherit">
                                    <div>
                                        Trasa <strong>{{ state.line }} {{ state.name }} </strong> posiada wskazany wariant.
                                    </div>
                                    <div>
                                        Nazwa wariantu: <strong>{{ modelForm.controls["tripVariantName"].value }}</strong>
                                    </div>
                                    <div>
                                        Kierunek wariantu: <strong> {{ "agency.trip.edit." + modelForm.controls["tripVariantMode"].value | transloco }} </strong>
                                    </div>
                                    <div>
                                        Ruch panujący na drodze: <strong>{{ "agency.trip.traffic." + modelForm.controls["tripTrafficMode"].value | transloco }}</strong>
                                    </div>
                                </span>
                            }
                            <div class="text-gray-800 text-2sm">
                                <span class="text-danger uppercase">{{ 'common.attention' | transloco | uppercase }}
                                    :</span>
                                Linia posiada 2 warianty podstawowe (TAM i POWRÓT).
                            </div>

                            <div class="w-full">
                                <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                    <label class="form-label max-w-56">Nazwa wariantu</label>
                                    <!--                                    @if (isMainVariant()) {-->
                                    <!--                                        <input name="tripVariantName" id="tripVariantName"-->
                                    <!--                                               formControlName="tripVariantName"-->
                                    <!--                                               class="input" type="text"-->
                                    <!--                                               value="{{'agency.trip.edit.mainVariant' | transloco }}"-->
                                    <!--                                                disabled>-->
                                    <!--                                    } @else {-->
                                    <input name="tripVariantName" id="tripVariantName"
                                           formControlName="tripVariantName"
                                           class="input" type="text" placeholder="Nazwa wariantu"
                                           [ngClass]="{'border-danger': canCheckErrors('tripVariantName') }">
                                    <!--                                    }-->
                                </div>
                                @if (checkControlHasError("tripVariantName", "required")) {
                                    <span class="text-danger text-2sm">Nazwa wariantu jest wymagana</span>
                                }
                            </div>

                            <!--                            {{ checkControlHasError("tripVariantName", "required") }}-->
                            <!--                            {{ checkControlHasError("tripVariantMode", "required") }}-->
                            <!--                            {{ checkControlHasError("tripTrafficMode", "required") }}-->

                            <div class="w-full">
                                <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                    <label class="form-label max-w-56">Kierunek wariantu</label>
                                    <select name="tripVariantMode" id="tripVariantMode"
                                            formControlName="tripVariantMode" class="select w-full"
                                            [ngClass]="{'border-danger': validControl('tripVariantMode')}">
                                        <option [value]="tripModeSelectValue.Front">{{ 'agency.trip.edit.FRONT' | transloco }}</option>
                                        <option [value]="tripModeSelectValue.Back">{{ 'agency.trip.edit.BACK' | transloco }}</option>
                                    </select>
                                </div>
                                @if (checkControlHasError("tripVariantMode", "required")) {
                                    <span class="text-danger text-2sm">Kierunek wariantu jest wymagany</span>
                                }
                            </div>

                            <div class="flex flex-col gap-7.5 divide-y divide-gray-200">
                                <div class="grid gap-7">
                                    <label class="form-label max-w-56">Ruch panujący na drodze</label>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 lg:gap-7.5">
                                        <label class="flex align-stretch cursor-pointer bg-center h-32 bg-no-repeat border rounded-xl border-dashed has-[:checked]:border-primary bg-[length:500px] sso-active singl-sign-on-bg"
                                               [ngClass]="canCheckErrors('tripTrafficMode') ?'border-danger': 'border-gray-300'">
                                            <div class="flex flex-col place-items-center place-content-center rounded-xl grow">
                                                <div class="flex items-center h-11">
                                                    <img alt="" class="w-12"
                                                         src="assets/media/svg/bus-svgrepo-com.svg"/>
                                                </div>
                                                <span class="text-md font-medium text-gray-900"> {{ "agency.trip.traffic." + trafficModeSelectValue.Normal | transloco }}</span>
                                                <input class="appearance-none" name="tripTrafficMode" type="radio"
                                                       [value]="trafficModeSelectValue.Normal"
                                                       formControlName="tripTrafficMode"/>
                                            </div>
                                        </label>
                                        <label class="flex align-stretch cursor-pointer bg-center h-32 bg-no-repeat border rounded-xl border-dashed has-[:checked]:border-primary bg-[length:500px] sso-active singl-sign-on-bg"
                                               [ngClass]="canCheckErrors('tripTrafficMode') ?'border-danger': 'border-gray-300'">
                                            <div class="flex flex-col place-items-center place-content-center rounded-xl grow">
                                                <div class="flex items-center h-11">
                                                    <img alt="" class="w-12"
                                                         src="assets/media/svg/traffic-jam-svgrepo-com.svg"/>
                                                </div>
                                                <span class="text-md font-medium text-gray-900"> {{ "agency.trip.traffic." + trafficModeSelectValue.Traffic | transloco }}</span>
                                                <input class="appearance-none" name="tripTrafficMode" type="radio"
                                                       [value]="trafficModeSelectValue.Traffic"
                                                       formControlName="tripTrafficMode"/>
                                            </div>
                                        </label>
                                    </div>
                                    @if (checkControlHasError("tripTrafficMode", "required")) {
                                        <span class="text-danger text-2sm">Ruch panujący jest na drodze jest wymagany</span>
                                    }
                                    <style>
                                        .sso-active:has(:checked) {
                                            background-image: url('assets/media/images/2600x1600/bg-1.png');
                                        }

                                        .dark .sso-active:has(:checked) {
                                            background-image: url('assets/media/images/2600x1600/bg-1-dark.png');
                                        }
                                    </style>
                                </div>
                            </div>


                            @if (!isMainVariant()) {
                                <div class="border-t border-gray-200 my-2.5"></div>
                                <div class="w-full">
                                    <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                        <label class="form-label max-w-56">Symbol jakim oznaczysz kurs na rozkładzie
                                            jazdy</label>
                                        <input formControlName="variantDesignation" name="variantDesignation"
                                               id="variantDesignation" class="input" type="text"
                                               [ngClass]="{'border-danger': validControl('variantDesignation')}"
                                               placeholder="Symbol kursu na rozkładzie"/>
                                    </div>
                                    @if (checkControlHasError("variantDesignation", "required")) {
                                        <span class="text-danger text-2sm">W przypadku gdy wariant nie jest wariantem podstawowym, proszę o podanie w jaki sposób oznaczyć kurs na rozkładzie jazdy</span>
                                    }
                                </div>
                                <div class="w-full">
                                    <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                        <label class="form-label max-w-56">Opis oznaczenia</label>
                                        <input formControlName="variantDescription" name="variantDescription"
                                               id="variantDescription"
                                               class="input" type="text"
                                               [ngClass]="{'border-danger': validControl('variantDescription')}"
                                               placeholder="Wyjaśnienie oznaczenia"/>
                                    </div>
                                    @if (checkControlHasError("variantDescription", "required")) {
                                        <span class="text-danger text-2sm">Podaj naw w jaki sposób wyjaśnić pasazerom co oznacza oznaczenie <strong>{{ modelForm.controls['variantDesignation']?.value }}</strong> na rozkładzie </span>
                                    }
                                </div>
                            }
                            <div class="border-t border-gray-200 my-2.5"></div>

                            <div class="w-full">
                                <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                    <label class="form-label max-w-56">Przystanek początkowy</label>
                                    <input type="text" formControlName="origin" name="origin" id="origin"
                                           class="input" placeholder="Przystanek początkowy"
                                           [ngClass]="{'border-danger': canCheckErrors('origin') }">
                                </div>
                                @if (checkControlHasError("origin", "required")) {
                                    <span class="text-danger text-2sm">Podaj nazwę przystaneku początkowego</span>
                                }
                            </div>

                            <div class="w-full">
                                <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                    <label class="form-label max-w-56">Przystanek końcowy</label>
                                    <input type="text" formControlName="destination" name="destination" id="destination"
                                           class="input" placeholder="Przystanek końcowy"
                                           [ngClass]="{'border-danger': canCheckErrors('destination') }">
                                </div>
                                @if (checkControlHasError("destination", "required")) {
                                    <span class="text-danger text-2sm">Podaj nazwę przystanku końcowego</span>
                                }
                            </div>

                            <div class="w-full">
                                <div class="flex items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                                    <label class="form-label max-w-56">Kierunek na tablicy czołowej</label>
                                    <input type="text" formControlName="headsign" name="headsign" id="headsign"
                                           class="input" placeholder="Tablica czołowa"
                                           [ngClass]="{'border-danger': canCheckErrors('headsign') }">
                                </div>
                                @if (checkControlHasError("headsign", "required")) {
                                    <span class="text-danger text-2sm">Podaj co wyświetlić jest na tablicy czołowej</span>
                                }
                            </div>
                            <div class="flex justify-end">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-span-1 lg:col-span-2">
                <div class="flex flex-col gap-5 lg:gap-7.5">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                Przystanki autobusowe
                            </h3>
                        </div>

                        <div class="card-table scrollable-x-auto pb-3">
                            <table class="table align-middle text-sm text-gray-500">
                                <tr>
                                    <td class="py-2">
                                        <div>Prędkość komunikacyjna</div>
                                        @if (checkControlHasError("calculatedCommunicationVelocity", "required")) {
                                            <span class="text-danger text-2sm">Prędkość komunikacyjna jest wymagana</span>
                                        } @else if (checkControlHasError("calculatedCommunicationVelocity", "min")) {
                                            <span class="text-danger text-2sm">Minimalna prędkość musi być większa niż 0. Bieżąca wartość to: {{ modelForm.controls["calculatedCommunicationVelocity"].value }}</span>
                                        }
                                    </td>
                                    <td class="py-2 justify-items-end">
                                        <div class="input-group w-32">
                                            <input type="number" formControlName="calculatedCommunicationVelocity"
                                                   name="calculatedCommunicationVelocity"
                                                   id="calculatedCommunicationVelocity" class="input "
                                                   [ngClass]="{'border-t-danger border-b-danger border-l-danger': canCheckErrors('calculatedCommunicationVelocity')}">
                                            <span class="btn btn-secondary"
                                                  [ngClass]="{'border-t-danger border-r-danger border-b-danger': canCheckErrors('calculatedCommunicationVelocity')}">km/h</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3">Dystans (Czas przejazdu)</td>
                                    <td class="py-3 text-gray-700 text-2sm font-normal text-end">
                                        {{ getLastStop()?.meters | distance | number: '1.1-1' }} km
                                        ({{ getLastStop()?.calculatedSeconds | time | number: '1.0-0' }} min)
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <div class="flex items-center justify-between border border-gray-200 rounded-xl gap-2 px-3.5 py-2.5">
                                            <div class="flex items-center flex-wrap gap-3.5">
                                                <!--                                <img src="/assets/media/brand-logos/google.svg" class="size-6 shrink-0" alt="">-->
                                                <div class="flex flex-col gap-0.5">
                                                    <!--                                    <span class="text-sm font-medium text-gray-900">Ręczna modyfikacja</span>-->
                                                    <span class="text-2sm text-gray-700">
                                        <strong>Chcę korygować ręcznie zaproponowany czas przejazdu</strong>,
                                        chce samodzielnie zmienić lub dostosować czas trwania przejazdu,
                                        który został wcześniej automatycznie wyliczony lub zasugerowany.</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-5">
                                                <label class="switch switch-sm">
                                                    <input type="checkbox" formControlName="isCustomized"></label>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                @if (isCustomized()) {
                                    <tr>
                                        <td class="py-3">Rzeczywista prędkość komunikacyjna</td>
                                        <td class="py-3 text-gray-700 text-2sm font-normal text-end">
                                            {{ customizedCommunicationVelocity() | number: '1.0-0' }} km/h
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">Dystans (Rzeczywisty Czas przejazdu)</td>
                                        <td class="py-3 text-gray-700 text-2sm font-normal text-end">
                                            {{ getLastStop()?.meters | distance | number: '1.1-1' }} km
                                            ({{ getLastStop()?.customizedMinutes | number: '1.0-0' }} min)
                                        </td>
                                    </tr>
                                }
                            </table>
                        </div>

                        <div class="border-t border-gray-200 my-0"></div>

                        <!--<div class="card-body">-->
                        <div cdkDropList class="example-list" (cdkDropListDropped)="drop($event)">
                        <span [@heightCollapse]="isRefreshingExpanded ? 'expanded' : 'collapsed'"
                              class="badge badge-sm badge-outline badge-danger w-full">
                            <app-count-down [initialSeconds]="10" [forceRefresh]="forceRefresh$"
                                            (onTime)="refreshMap()"></app-count-down>
                        </span>

                            <span [@heightCollapse]="isRefreshExpanded ? 'expanded' : 'collapsed'"
                                  class="badge badge-sm badge-outline badge-success w-full">
                                Trasa, czas przjazdu i dystans są zaktualizowane.
                        </span>

                            @for (stopTime of stopTimes; track stopTime; let index = $index) {
                                <div class="example-box" cdkDrag [@simpleFadeAnimation]="'in'">
                                <span>
                                    <span [ngClass]="{'blue': stopTime.bdot10k, 'dark-blue': !stopTime.bdot10k}">{{ index + 1 }}</span>
                                    <span>{{ stopTime?.stopName }} </span>
                                </span>

                                    <span>
                                    <span (click)="openDialogEditStop(stopTime)">
                                        <a class="btn btn-sm btn-icon btn-clear btn-primary">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </span>
                                    <span>{{ stopTime.meters | distance | number: '1.1-1' }}</span>
                                    <span>km ({{ stopTime.calculatedSeconds | time | number: '1.0-0' }} min)</span>

                                        @if (isCustomized()) {
                                            <div class="inline-block">
                                            <div class="input-group mx-1">
                                                <input type="number" id="customizedMinutesControl-{{index}}"
                                                       name="customizedMinutesControl-{{index}}"
                                                       [formControl]="stopTime.customizedMinutesControl"
                                                       class="input w-14 h-7.5"/>
                                                <span class="btn btn-secondary h-7.5 px-1">min</span>
                                            </div>
                                        </div>
                                        }
                                        <span (click)="remove(stopTime)">
                                        <a class="btn btn-sm btn-icon btn-clear btn-danger">
                                            <i class="ki-filled ki-cross-square"></i>
                                        </a>
                                    </span>
                                </span>
                                </div>
                            }
                            <!--                        @if (isRefreshingExpanded) {-->
                            <span [@heightCollapse]="isRefreshingExpanded ? 'expanded' : 'collapsed'"
                                  class="badge badge-sm badge-outline badge-danger w-full">
                                <app-count-down [initialSeconds]="10" [forceRefresh]="forceRefresh$"></app-count-down>
                        </span>
                            <!--                        }-->

                            <!--                        @if (isRefreshExpanded) {-->
                            <span [@heightCollapse]="isRefreshExpanded ? 'expanded' : 'collapsed'"
                                  class="badge badge-sm badge-outline badge-success w-full">
                                Trasa, czas przjazdu i dystans są zaktualizowane.
                            </span>
                            <!--                        }-->
                        </div>
                        <!--</div>-->

                        <div class="card-body pr-2">
                            <div class="flex justify-end gap-2">
                                <button (click)="measureDistance()" class="btn btn-secondary px-3">
                                    <i class="ki-filled ki-arrows-circle"></i>
                                </button>
                                <!--                            <button (click)="addBrake()" class="btn btn-secondary pr-2">-->
                                <!--                                Dodaj postój na przystanku-->
                                <!--                            </button>-->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                Mapa
                            </h3>
                            <a (click)="zoomPolyline()" class="btn btn-link">Zoom</a>
                        </div>
                        <span [@heightCollapse]="isRefreshingExpanded ? 'expanded' : 'collapsed'"
                              class="badge badge-sm badge-outline badge-danger w-full">
                                <app-count-down [initialSeconds]="10" [forceRefresh]="forceRefresh$"></app-count-down>
                    </span>

                        <span [@heightCollapse]="isRefreshExpanded ? 'expanded' : 'collapsed'"
                              class="badge badge-sm badge-outline badge-success w-full">
                                Trasa, czas przjazdu i dystans są zaktualizowane.
                    </span>

                        <!--<div style="display: grid" class="card-body p-5 lg:p-7.5 lg:pb-7">-->
                        <div style="display: grid">
                            <div class="map-container">
                                <div id="map"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pr-2">
                        <div class="flex justify-end gap-2">
                            <button type="submit" class="btn btn-success">
                                Zapisz Przystanki i wróć do listy wariantów
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </form>
    <!-- end: grid -->
</div>
<!-- End of Container -->

